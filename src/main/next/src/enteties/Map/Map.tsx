"use client"
import * as React from "react"
import { useRef, useCallback, useState, useMemo } from "react"
import { createRoot } from "react-dom/client"
import { Map, Marker, Popup, Source, Layer } from "react-map-gl"

import {
  clusterLayer,
  clusterCountLayer,
  unclusteredPointLayer,
  areaLayer,
  pointLayer,
  heatmapLayer,
} from "./mapstyle"

import type { MapRef } from "react-map-gl"
import type { GeoJSONSource } from "react-map-gl"

type MapProps = {
  zoom?: [number]
  center?: [number, number]
  style?: string
  interactive?: boolean
  pitch?: number
  bearing?: number
  data: any
  handler?: any
  options?: MapOptions
}

type DetailsProps = {
  summary: string
  content: React.ReactNode
}

const centerPosition = [68.970663, 33.074918]
export const Details = ({ summary, content }: DetailsProps) => {
  return (
    <details>
      <summary>{summary}</summary>
      {content}
    </details>
  )
}
const MapComponent: React.FC<MapProps> = ({ data }: Partial<MapProps>) => {
  const mapRef = useRef<MapRef>(null)
  const [hoverInfo, setHoverInfo] = useState(null)
  const onHover = useCallback((event) => {
    const {
      features,
      point: { x, y },
    } = event
    const hoveredFeature = features && features[0]
    setHoverInfo(hoveredFeature && { feature: hoveredFeature, x, y })
  }, [])
  const [popupInfo, setPopupInfo] = useState(null)

  const pins = useMemo(
    () =>
      data.features.map((feature) => (
        <Marker
          key={`marker-${feature.id}`}
          longitude={feature.geometry.coordinates[0]}
          latitude={feature.geometry.coordinates[1]}
          anchor="bottom"
          onClick={(e) => {
            // If we let the click event propagates to the map, it will immediately close the popup
            // with `closeOnClick: true`
            e.originalEvent.stopPropagation()
            setPopupInfo(feature)
          }}
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="25"
            height="25"
            viewBox="0 0 25 25"
            fill="none"
          >
            <g clip-path="url(#clip0_51_352)">
              <mask id="path-1-inside-1_51_352" fill="white">
                <path d="M12.2186 2.09668C6.71395 2.09668 2.24076 6.56477 2.24076 12.0669C2.24076 17.569 6.71395 22.0371 12.2186 22.0371C17.7233 22.0371 22.1965 17.569 22.1965 12.0669C22.1863 6.56477 17.7233 2.09668 12.2186 2.09668ZM12.2186 21.4754C7.02033 21.4754 2.81267 17.2626 2.81267 12.0669C2.81267 6.87115 7.02033 2.65838 12.2186 2.65838C17.4169 2.65838 21.6246 6.87115 21.6246 12.0669C21.6246 17.2626 17.4067 21.4626 12.2186 21.4754ZM16.845 10.0499H14.2408V7.44562C14.2408 6.84562 13.7505 6.34775 13.148 6.34775H11.2893C10.6867 6.34775 10.1965 6.84562 10.1965 7.44562V10.0499H7.59225C6.98969 10.0499 6.50969 10.535 6.49948 11.135V12.9988C6.50969 13.5988 6.98969 14.0839 7.59225 14.0839H10.1965V16.6882C10.1965 17.2882 10.6867 17.786 11.2893 17.786H13.148C13.7505 17.786 14.2408 17.2882 14.2408 16.6882V14.0839H16.845C17.4476 14.0839 17.9276 13.5988 17.9378 12.9988V11.135C17.9276 10.535 17.4476 10.0499 16.845 10.0499ZM17.3659 12.9988C17.3659 13.2924 17.131 13.5222 16.845 13.5222H13.9548C13.8016 13.5222 13.6688 13.6499 13.6688 13.8031V16.6882C13.6688 16.9818 13.4339 17.2116 13.148 17.2116H11.2893C11.0033 17.2116 10.7684 16.9818 10.7582 16.6882V13.8031C10.7582 13.6499 10.6356 13.5222 10.4825 13.5222H7.59225C7.30629 13.5222 7.07139 13.2924 7.07139 12.9988V11.135C7.07139 10.8414 7.30629 10.6116 7.59225 10.6116H10.4825C10.6356 10.6116 10.7684 10.4839 10.7684 10.3307V7.44562C10.7684 7.152 11.0033 6.92221 11.2893 6.92221H13.148C13.4442 6.92221 13.6791 7.152 13.6791 7.44562V10.3307C13.6791 10.4839 13.8016 10.6116 13.9548 10.6116H16.845C17.131 10.6116 17.3659 10.8414 17.3659 11.135V12.9988ZM12.2186 0.0668945C5.59054 0.0668945 0.218628 5.44136 0.218628 12.0669C0.218628 18.6924 5.59054 24.0669 12.2186 24.0669C18.8467 24.0669 24.2186 18.6924 24.2186 12.0669C24.2084 5.44136 18.8365 0.0796605 12.2186 0.0668945ZM12.2186 23.4924C5.90714 23.4924 0.790543 18.3733 0.790543 12.0669C0.790543 5.76051 5.90714 0.641363 12.2186 0.641363C18.5301 0.641363 23.6467 5.76051 23.6467 12.0669C23.6365 18.3733 18.5301 23.4924 12.2186 23.4924Z" />
              </mask>
              <path
                d="M12.2186 2.09668C6.71395 2.09668 2.24076 6.56477 2.24076 12.0669C2.24076 17.569 6.71395 22.0371 12.2186 22.0371C17.7233 22.0371 22.1965 17.569 22.1965 12.0669C22.1863 6.56477 17.7233 2.09668 12.2186 2.09668ZM12.2186 21.4754C7.02033 21.4754 2.81267 17.2626 2.81267 12.0669C2.81267 6.87115 7.02033 2.65838 12.2186 2.65838C17.4169 2.65838 21.6246 6.87115 21.6246 12.0669C21.6246 17.2626 17.4067 21.4626 12.2186 21.4754ZM16.845 10.0499H14.2408V7.44562C14.2408 6.84562 13.7505 6.34775 13.148 6.34775H11.2893C10.6867 6.34775 10.1965 6.84562 10.1965 7.44562V10.0499H7.59225C6.98969 10.0499 6.50969 10.535 6.49948 11.135V12.9988C6.50969 13.5988 6.98969 14.0839 7.59225 14.0839H10.1965V16.6882C10.1965 17.2882 10.6867 17.786 11.2893 17.786H13.148C13.7505 17.786 14.2408 17.2882 14.2408 16.6882V14.0839H16.845C17.4476 14.0839 17.9276 13.5988 17.9378 12.9988V11.135C17.9276 10.535 17.4476 10.0499 16.845 10.0499ZM17.3659 12.9988C17.3659 13.2924 17.131 13.5222 16.845 13.5222H13.9548C13.8016 13.5222 13.6688 13.6499 13.6688 13.8031V16.6882C13.6688 16.9818 13.4339 17.2116 13.148 17.2116H11.2893C11.0033 17.2116 10.7684 16.9818 10.7582 16.6882V13.8031C10.7582 13.6499 10.6356 13.5222 10.4825 13.5222H7.59225C7.30629 13.5222 7.07139 13.2924 7.07139 12.9988V11.135C7.07139 10.8414 7.30629 10.6116 7.59225 10.6116H10.4825C10.6356 10.6116 10.7684 10.4839 10.7684 10.3307V7.44562C10.7684 7.152 11.0033 6.92221 11.2893 6.92221H13.148C13.4442 6.92221 13.6791 7.152 13.6791 7.44562V10.3307C13.6791 10.4839 13.8016 10.6116 13.9548 10.6116H16.845C17.131 10.6116 17.3659 10.8414 17.3659 11.135V12.9988ZM12.2186 0.0668945C5.59054 0.0668945 0.218628 5.44136 0.218628 12.0669C0.218628 18.6924 5.59054 24.0669 12.2186 24.0669C18.8467 24.0669 24.2186 18.6924 24.2186 12.0669C24.2084 5.44136 18.8365 0.0796605 12.2186 0.0668945ZM12.2186 23.4924C5.90714 23.4924 0.790543 18.3733 0.790543 12.0669C0.790543 5.76051 5.90714 0.641363 12.2186 0.641363C18.5301 0.641363 23.6467 5.76051 23.6467 12.0669C23.6365 18.3733 18.5301 23.4924 12.2186 23.4924Z"
                fill="white"
              />
              <path
                d="M22.1965 12.0669L25.1965 12.0669L25.1965 12.0613L22.1965 12.0669ZM12.2186 21.4754L12.2186 24.4754L12.226 24.4754L12.2186 21.4754ZM14.2408 10.0499H11.2408V13.0499H14.2408V10.0499ZM10.1965 10.0499V13.0499H13.1965V10.0499H10.1965ZM6.49948 11.135L3.49991 11.0839L3.49948 11.1095V11.135H6.49948ZM6.49948 12.9988H3.49948V13.0243L3.49991 13.0499L6.49948 12.9988ZM10.1965 14.0839H13.1965V11.0839H10.1965V14.0839ZM14.2408 14.0839V11.0839H11.2408V14.0839H14.2408ZM17.9378 12.9988L20.9373 13.0499L20.9378 13.0243V12.9988H17.9378ZM17.9378 11.135H20.9378V11.1095L20.9373 11.0839L17.9378 11.135ZM10.7582 16.6882H7.7582V16.7403L7.76002 16.7925L10.7582 16.6882ZM12.2186 0.0668945L12.2244 -2.93311H12.2186V0.0668945ZM24.2186 12.0669L27.2186 12.0669L27.2186 12.0623L24.2186 12.0669ZM23.6467 12.0669L26.6467 12.0718V12.0669H23.6467ZM12.2186 -0.903318C5.05959 -0.903318 -0.759244 4.90541 -0.759244 12.0669H5.24076C5.24076 8.22412 8.3683 5.09668 12.2186 5.09668V-0.903318ZM-0.759244 12.0669C-0.759244 19.2284 5.05959 25.0371 12.2186 25.0371V19.0371C8.3683 19.0371 5.24076 15.9097 5.24076 12.0669H-0.759244ZM12.2186 25.0371C19.3777 25.0371 25.1965 19.2284 25.1965 12.0669H19.1965C19.1965 15.9097 16.069 19.0371 12.2186 19.0371V25.0371ZM25.1965 12.0613C25.1832 4.90927 19.3827 -0.903318 12.2186 -0.903318V5.09668C16.0639 5.09668 19.1894 8.22027 19.1965 12.0725L25.1965 12.0613ZM12.2186 18.4754C8.67877 18.4754 5.81267 15.6074 5.81267 12.0669H-0.187329C-0.187329 18.9179 5.36189 24.4754 12.2186 24.4754V18.4754ZM5.81267 12.0669C5.81267 8.52641 8.67878 5.65838 12.2186 5.65838V-0.341616C5.36188 -0.341616 -0.187329 5.21589 -0.187329 12.0669H5.81267ZM12.2186 5.65838C15.7585 5.65838 18.6246 8.52641 18.6246 12.0669H24.6246C24.6246 5.21589 19.0754 -0.341616 12.2186 -0.341616V5.65838ZM18.6246 12.0669C18.6246 15.5985 15.7555 18.4667 12.2112 18.4754L12.226 24.4754C19.0579 24.4586 24.6246 18.9267 24.6246 12.0669H18.6246ZM16.845 7.04987H14.2408V13.0499H16.845V7.04987ZM17.2408 10.0499V7.44562H11.2408V10.0499H17.2408ZM17.2408 7.44562C17.2408 5.21153 15.4301 3.34775 13.148 3.34775V9.34775C12.071 9.34775 11.2408 8.47971 11.2408 7.44562H17.2408ZM13.148 3.34775H11.2893V9.34775H13.148V3.34775ZM11.2893 3.34775C9.00718 3.34775 7.1965 5.21153 7.1965 7.44562H13.1965C13.1965 8.47971 12.3662 9.34775 11.2893 9.34775V3.34775ZM7.1965 7.44562V10.0499H13.1965V7.44562H7.1965ZM10.1965 7.04987H7.59225V13.0499H10.1965V7.04987ZM7.59225 7.04987C5.30974 7.04987 3.53725 8.89055 3.49991 11.0839L9.49905 11.186C9.48214 12.1794 8.66965 13.0499 7.59225 13.0499V7.04987ZM3.49948 11.135V12.9988H9.49948V11.135H3.49948ZM3.49991 13.0499C3.53725 15.2432 5.30973 17.0839 7.59225 17.0839V11.0839C8.66965 11.0839 9.48214 11.9544 9.49905 12.9478L3.49991 13.0499ZM7.59225 17.0839H10.1965V11.0839H7.59225V17.0839ZM7.1965 14.0839V16.6882H13.1965V14.0839H7.1965ZM7.1965 16.6882C7.1965 18.9223 9.00719 20.786 11.2893 20.786V14.786C12.3662 14.786 13.1965 15.6541 13.1965 16.6882H7.1965ZM11.2893 20.786H13.148V14.786H11.2893V20.786ZM13.148 20.786C15.4301 20.786 17.2408 18.9223 17.2408 16.6882H11.2408C11.2408 15.6541 12.071 14.786 13.148 14.786V20.786ZM17.2408 16.6882V14.0839H11.2408V16.6882H17.2408ZM14.2408 17.0839H16.845V11.0839H14.2408V17.0839ZM16.845 17.0839C19.1275 17.0839 20.9 15.2432 20.9373 13.0499L14.9382 12.9478C14.9551 11.9544 15.7676 11.0839 16.845 11.0839V17.0839ZM20.9378 12.9988V11.135H14.9378V12.9988H20.9378ZM20.9373 11.0839C20.9 8.89055 19.1275 7.04987 16.845 7.04987V13.0499C15.7676 13.0499 14.9551 12.1794 14.9382 11.186L20.9373 11.0839ZM14.3659 12.9988C14.3659 11.626 15.4837 10.5222 16.845 10.5222V16.5222C18.7782 16.5222 20.3659 14.9588 20.3659 12.9988H14.3659ZM16.845 10.5222H13.9548V16.5222H16.845V10.5222ZM13.9548 10.5222C12.215 10.5222 10.6688 11.9236 10.6688 13.8031H16.6688C16.6688 15.3761 15.3882 16.5222 13.9548 16.5222V10.5222ZM10.6688 13.8031V16.6882H16.6688V13.8031H10.6688ZM10.6688 16.6882C10.6688 15.3154 11.7867 14.2116 13.148 14.2116V20.2116C15.0812 20.2116 16.6688 18.6482 16.6688 16.6882H10.6688ZM13.148 14.2116H11.2893V20.2116H13.148V14.2116ZM11.2893 14.2116C12.6693 14.2116 13.7122 15.3124 13.7564 16.5839L7.76002 16.7925C7.82467 18.6512 9.33733 20.2116 11.2893 20.2116V14.2116ZM13.7582 16.6882V13.8031H7.7582V16.6882H13.7582ZM13.7582 13.8031C13.7582 12.0651 12.3636 10.5222 10.4825 10.5222V16.5222C8.90765 16.5222 7.7582 15.2347 7.7582 13.8031H13.7582ZM10.4825 10.5222H7.59225V16.5222H10.4825V10.5222ZM7.59225 10.5222C8.95357 10.5222 10.0714 11.626 10.0714 12.9988H4.07139C4.07139 14.9588 5.65901 16.5222 7.59225 16.5222V10.5222ZM10.0714 12.9988V11.135H4.07139V12.9988H10.0714ZM10.0714 11.135C10.0714 12.5078 8.95356 13.6116 7.59225 13.6116V7.61158C5.65901 7.61158 4.07139 9.17494 4.07139 11.135H10.0714ZM7.59225 13.6116H10.4825V7.61158H7.59225V13.6116ZM10.4825 13.6116C12.2222 13.6116 13.7684 12.2102 13.7684 10.3307H7.76842C7.76842 8.75766 9.04906 7.61158 10.4825 7.61158V13.6116ZM13.7684 10.3307V7.44562H7.76842V10.3307H13.7684ZM13.7684 7.44562C13.7684 8.81842 12.6506 9.92221 11.2893 9.92221V3.92221C9.35603 3.92221 7.76842 5.48559 7.76842 7.44562H13.7684ZM11.2893 9.92221H13.148V3.92221H11.2893V9.92221ZM13.148 9.92221C11.835 9.92221 10.6791 8.8562 10.6791 7.44562H16.6791C16.6791 5.44781 15.0533 3.92221 13.148 3.92221V9.92221ZM10.6791 7.44562V10.3307H16.6791V7.44562H10.6791ZM10.6791 10.3307C10.6791 12.0687 12.0736 13.6116 13.9548 13.6116V7.61158C15.5296 7.61158 16.6791 8.89913 16.6791 10.3307H10.6791ZM13.9548 13.6116H16.845V7.61158H13.9548V13.6116ZM16.845 13.6116C15.4837 13.6116 14.3659 12.5078 14.3659 11.135H20.3659C20.3659 9.17494 18.7782 7.61158 16.845 7.61158V13.6116ZM14.3659 11.135V12.9988H20.3659V11.135H14.3659ZM12.2186 -2.93311C3.93327 -2.93311 -2.78137 3.78492 -2.78137 12.0669H3.21863C3.21863 7.0978 7.24781 3.06689 12.2186 3.06689V-2.93311ZM-2.78137 12.0669C-2.78137 20.3489 3.93327 27.0669 12.2186 27.0669V21.0669C7.24781 21.0669 3.21863 17.036 3.21863 12.0669H-2.78137ZM12.2186 27.0669C20.504 27.0669 27.2186 20.3489 27.2186 12.0669H21.2186C21.2186 17.036 17.1894 21.0669 12.2186 21.0669V27.0669ZM27.2186 12.0623C27.2059 3.7812 20.4923 -2.91715 12.2244 -2.9331L12.2128 3.06689C17.1807 3.07647 21.211 7.10153 21.2186 12.0715L27.2186 12.0623ZM12.2186 20.4924C7.56399 20.4924 3.79054 16.7164 3.79054 12.0669H-2.20946C-2.20946 20.0301 4.25029 26.4924 12.2186 26.4924V20.4924ZM3.79054 12.0669C3.79054 7.41737 7.56399 3.64136 12.2186 3.64136V-2.35864C4.25028 -2.35864 -2.20946 4.10366 -2.20946 12.0669H3.79054ZM12.2186 3.64136C16.8733 3.64136 20.6467 7.41737 20.6467 12.0669H26.6467C26.6467 4.10366 20.187 -2.35864 12.2186 -2.35864V3.64136ZM20.6467 12.062C20.6392 16.7198 16.8688 20.4924 12.2186 20.4924V26.4924C20.1914 26.4924 26.6338 20.0268 26.6467 12.0718L20.6467 12.062Z"
                fill="#E74F48"
                mask="url(#path-1-inside-1_51_352)"
              />
            </g>
            <defs>
              <clipPath id="clip0_51_352">
                <rect width="25" height="25" fill="white" />
              </clipPath>
            </defs>
          </svg>
        </Marker>
      )),
    []
  )

  const onZoom = (event) => {
    if (event.features !== undefined) {
      const feature = event.features[0]
      const clusterId = feature.properties.cluster_id

      const mapboxSource = mapRef.current.getSource("data") as GeoJSONSource

      mapboxSource.getClusterExpansionZoom(clusterId, (err, zoom) => {
        if (err) {
          return
        }

        mapRef.current.easeTo({
          center: feature.geometry.coordinates,
          zoom,
          duration: 500,
        })
      })
    }
  }
  const [viewState, setViewState] = React.useState({
    longitude: 64,
    latitude: 64,
    zoom: 2.5,
  })
  return (
    <Map
      {...viewState}
      onMove={(evt) => setViewState(evt.viewState)}
      mapStyle="mapbox://styles/mapbox/dark-v9"
      mapboxAccessToken={process.env.NEXT_PUBLIC_MAP_TOKEN}
      interactiveLayerIds={[
        clusterLayer.id!,
        "area",
        "heatmap",
        "multiPolygonLayer",
        "point",
      ]}
      onZoomStart={onZoom}
      ref={mapRef}
      onClick={onHover}
    >
      <Source
        id="point"
        type="geojson"
        data={data}
        cluster={true}
        clusterMaxZoom={14}
        clusterRadius={50}
      >
        <Layer {...heatmapLayer} />
        <Layer {...pointLayer} />
        <Layer {...areaLayer} />
        <Layer {...clusterLayer} />
        <Layer {...clusterCountLayer} />
        <Layer {...unclusteredPointLayer} />
      </Source>

      {viewState.zoom > 7 && pins}

      {viewState.zoom > 7 && popupInfo && (
        <Popup
          style={{
            opacity: viewState.zoom > 7 ? 1 : 0,
          }}
          anchor="top"
          longitude={Number(popupInfo?.geometry.coordinates[0])}
          latitude={Number(popupInfo?.geometry.coordinates[1])}
          onClose={() => setPopupInfo(null)}
        >
          <div className="map-pin sub2">
            <span>{popupInfo.properties.region}</span>
            <span>{popupInfo.properties.municipality}</span>
            <span>{popupInfo.properties.settlement}</span>
            <span>{popupInfo.properties.type}</span>
            <strong>Население:</strong>
            <span>{popupInfo.properties.population}</span>
            <strong>Дети:</strong>
            <span>{popupInfo.properties.children}</span>
          </div>
        </Popup>
      )}
    </Map>
  )
}

export default MapComponent
